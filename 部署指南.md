# 部署指南

## 部署概述

本系统支持多种部署方式，适用于不同的环境和需求。

## 系统要求

### 基础要求
- **PHP**: 7.4 或更高版本
- **MySQL**: 5.7 或更高版本
- **Web服务器**: Apache/Nginx/PHP内置服务器
- **操作系统**: Linux/Windows/macOS

### 推荐配置
- **CPU**: 2核心以上
- **内存**: 4GB以上
- **存储**: 10GB可用空间
- **网络**: 稳定的网络连接

## 部署方法

### 方法一: 开发环境快速部署

**适用场景**: 本地开发、测试

**步骤**:

1. **下载项目**
   ```bash
   git clone https://github.com/CK627/FlightControlBoardMaintenanceWorkOrderSystem.git
   cd FlightControlBoardMaintenanceWorkOrderSystem
   ```

2. **配置数据库**
   ```bash
   # 编辑数据库配置
   vim config/mysql.ini
   ```
   
   配置内容:
   ```ini
   [database]
   host = 127.0.0.1
   user = root
   password = "123456"
   database = fcbmwos
   port = 3306
   charset = utf8
   ```

3. **启动服务**
   ```bash
   # 使用PHP内置服务器
   php -S localhost:8000
   ```

4. **初始化数据库**
   ```bash
   # 访问初始化页面
   open http://localhost:8000/database-init.html
   ```

5. **访问系统**
   ```bash
   open http://localhost:8000/login.html
   ```

### 方法二: Docker容器部署

**适用场景**: 快速部署、环境隔离

**步骤**:

1. **创建Dockerfile**
   ```dockerfile
   FROM php:8.1-apache
   
   # 安装PHP扩展
   RUN docker-php-ext-install mysqli pdo pdo_mysql
   
   # 复制项目文件
   COPY . /var/www/html/
   
   # 设置权限
   RUN chown -R www-data:www-data /var/www/html/
   RUN chmod -R 755 /var/www/html/
   
   # 暴露端口
   EXPOSE 80
   ```

2. **创建docker-compose.yml**
   ```yaml
   version: '3.8'
   
   services:
     web:
       build: .
       ports:
         - "8000:80"
       depends_on:
         - db
       volumes:
         - ./config:/var/www/html/config
       environment:
         - DB_HOST=db
         - DB_USER=root
         - DB_PASSWORD=123456
         - DB_NAME=fcbmwos
   
     db:
       image: mysql:8.0
       environment:
         MYSQL_ROOT_PASSWORD: 123456
         MYSQL_DATABASE: fcbmwos
       ports:
         - "3306:3306"
       volumes:
         - mysql_data:/var/lib/mysql
   
   volumes:
     mysql_data:
   ```

3. **启动容器**
   ```bash
   # 构建并启动
   docker-compose up -d
   
   # 查看状态
   docker-compose ps
   ```

4. **初始化数据库**
   ```bash
   # 访问初始化页面
   curl -X POST http://localhost:8000/api/database-init.php \
     -H "Content-Type: application/json" \
     -d '{"action":"initialize"}'
   ```

### 方法三: Apache服务器部署

**适用场景**: 生产环境、高性能需求

**步骤**:

1. **安装Apache和PHP**
   ```bash
   # Ubuntu/Debian
   sudo apt update
   sudo apt install apache2 php php-mysql php-json php-mbstring
   
   # CentOS/RHEL
   sudo yum install httpd php php-mysql php-json php-mbstring
   ```

2. **配置虚拟主机**
   ```bash
   # 创建虚拟主机配置
   sudo vim /etc/apache2/sites-available/fcbmwos.conf
   ```
   
   配置内容:
   ```apache
   <VirtualHost *:80>
       ServerName fcbmwos.local
       DocumentRoot /var/www/fcbmwos
       
       <Directory /var/www/fcbmwos>
           AllowOverride All
           Require all granted
       </Directory>
       
       ErrorLog ${APACHE_LOG_DIR}/fcbmwos_error.log
       CustomLog ${APACHE_LOG_DIR}/fcbmwos_access.log combined
   </VirtualHost>
   ```

3. **部署项目文件**
   ```bash
   # 复制项目文件
   sudo cp -r . /var/www/fcbmwos/
   
   # 设置权限
   sudo chown -R www-data:www-data /var/www/fcbmwos/
   sudo chmod -R 755 /var/www/fcbmwos/
   ```

4. **启用站点**
   ```bash
   # 启用站点
   sudo a2ensite fcbmwos.conf
   
   # 启用mod_rewrite
   sudo a2enmod rewrite
   
   # 重启Apache
   sudo systemctl restart apache2
   ```

5. **配置数据库**
   ```bash
   # 编辑配置文件
   sudo vim /var/www/fcbmwos/config/mysql.ini
   ```

### 方法四: Nginx + PHP-FPM部署

**适用场景**: 高并发、高性能需求

**步骤**:

1. **安装Nginx和PHP-FPM**
   ```bash
   # Ubuntu/Debian
   sudo apt install nginx php-fpm php-mysql php-json php-mbstring
   
   # CentOS/RHEL
   sudo yum install nginx php-fpm php-mysql php-json php-mbstring
   ```

2. **配置Nginx**
   ```bash
   sudo vim /etc/nginx/sites-available/fcbmwos
   ```
   
   配置内容:
   ```nginx
   server {
       listen 80;
       server_name fcbmwos.local;
       root /var/www/fcbmwos;
       index index.html index.php;
       
       location / {
           try_files $uri $uri/ =404;
       }
       
       location ~ \.php$ {
           include snippets/fastcgi-php.conf;
           fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
       }
       
       location ~ /\.ht {
           deny all;
       }
       
       # API路由
       location /api/ {
           try_files $uri $uri/ /api/index.php?$query_string;
       }
   }
   ```

3. **启用站点**
   ```bash
   # 创建软链接
   sudo ln -s /etc/nginx/sites-available/fcbmwos /etc/nginx/sites-enabled/
   
   # 测试配置
   sudo nginx -t
   
   # 重启服务
   sudo systemctl restart nginx
   sudo systemctl restart php8.1-fpm
   ```

### 方法五: 云服务器部署

**适用场景**: 生产环境、远程访问

#### 5.1 阿里云ECS部署

1. **购买ECS实例**
   - 选择合适的配置（2核4G推荐）
   - 选择Ubuntu 20.04或CentOS 8系统
   - 配置安全组（开放80、443、3306端口）

2. **连接服务器**
   ```bash
   ssh root@your-server-ip
   ```

3. **安装环境**
   ```bash
   # 更新系统
   apt update && apt upgrade -y
   
   # 安装LAMP环境
   apt install apache2 mysql-server php php-mysql php-json php-mbstring -y
   ```

4. **配置MySQL**
   ```bash
   # 安全配置
   mysql_secure_installation
   
   # 创建数据库
   mysql -u root -p
   CREATE DATABASE fcbmwos;
   CREATE USER 'fcbmwos'@'localhost' IDENTIFIED BY 'your_password';
   GRANT ALL PRIVILEGES ON fcbmwos.* TO 'fcbmwos'@'localhost';
   FLUSH PRIVILEGES;
   EXIT;
   ```

5. **部署项目**
   ```bash
   # 上传项目文件
   scp -r . root@your-server-ip:/var/www/html/fcbmwos/
   
   # 或使用git
   cd /var/www/html/
   git clone https://github.com/your-username/FlightControlBoardMaintenanceWorkOrderSystem.git fcbmwos
   ```

#### 5.2 腾讯云CVM部署

类似阿里云ECS，选择合适的实例配置和操作系统。

#### 5.3 AWS EC2部署

1. **启动EC2实例**
   - 选择Amazon Linux 2 AMI
   - 配置安全组规则
   - 创建或选择密钥对

2. **连接实例**
   ```bash
   ssh -i your-key.pem ec2-user@your-instance-ip
   ```

3. **安装环境**
   ```bash
   # 更新系统
   sudo yum update -y
   
   # 安装Apache和PHP
   sudo yum install httpd php php-mysql -y
   
   # 启动服务
   sudo systemctl start httpd
   sudo systemctl enable httpd
   ```

### 方法六: 宝塔面板部署

**适用场景**: 可视化管理、简化运维

**步骤**:

1. **安装宝塔面板**
   ```bash
   # CentOS
   yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
   
   # Ubuntu
   wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
   ```

2. **配置环境**
   - 登录宝塔面板
   - 安装LNMP或LAMP环境
   - 创建网站和数据库

3. **上传项目**
   - 使用文件管理器上传项目文件
   - 或通过Git拉取代码

4. **配置站点**
   - 设置网站目录
   - 配置PHP版本
   - 设置伪静态规则

### 方法七: 自动化部署

**适用场景**: CI/CD、批量部署

#### 7.1 使用Ansible

1. **创建Playbook**
   ```yaml
   ---
   - hosts: servers
     become: yes
     vars:
       project_path: /var/www/fcbmwos
       db_password: "{{ vault_db_password }}"
     
     tasks:
       - name: Install packages
         apt:
           name:
             - apache2
             - php
             - php-mysql
             - mysql-server
           state: present
       
       - name: Clone repository
         git:
           repo: https://github.com/your-username/FlightControlBoardMaintenanceWorkOrderSystem.git
           dest: "{{ project_path }}"
       
       - name: Set permissions
         file:
           path: "{{ project_path }}"
           owner: www-data
           group: www-data
           mode: '0755'
           recurse: yes
       
       - name: Configure database
         template:
           src: mysql.ini.j2
           dest: "{{ project_path }}/config/mysql.ini"
   ```

2. **执行部署**
   ```bash
   ansible-playbook -i inventory deploy.yml
   ```

#### 7.2 使用Shell脚本

```bash
#!/bin/bash
# deploy.sh - 自动部署脚本

set -e

PROJECT_DIR="/var/www/fcbmwos"
REPO_URL="https://github.com/your-username/FlightControlBoardMaintenanceWorkOrderSystem.git"
DB_NAME="fcbmwos"
DB_USER="fcbmwos"
DB_PASS="your_password"

echo "开始部署飞控板维修工单系统..."

# 更新系统
echo "更新系统包..."
apt update && apt upgrade -y

# 安装依赖
echo "安装依赖包..."
apt install -y apache2 php php-mysql mysql-server git

# 克隆项目
echo "克隆项目代码..."
if [ -d "$PROJECT_DIR" ]; then
    cd "$PROJECT_DIR"
    git pull
else
    git clone "$REPO_URL" "$PROJECT_DIR"
fi

# 设置权限
echo "设置文件权限..."
chown -R www-data:www-data "$PROJECT_DIR"
chmod -R 755 "$PROJECT_DIR"

# 配置数据库
echo "配置数据库..."
mysql -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
mysql -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';"
mysql -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
mysql -e "FLUSH PRIVILEGES;"

# 配置Apache
echo "配置Apache虚拟主机..."
cat > /etc/apache2/sites-available/fcbmwos.conf << EOF
<VirtualHost *:80>
    ServerName fcbmwos.local
    DocumentRoot $PROJECT_DIR
    <Directory $PROJECT_DIR>
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
EOF

# 启用站点
a2ensite fcbmwos.conf
a2enmod rewrite
systemctl restart apache2

# 初始化数据库
echo "初始化数据库..."
curl -X POST http://localhost/api/database-init.php \
  -H "Content-Type: application/json" \
  -d '{"action":"initialize"}'

echo "部署完成！"
echo "访问地址: http://your-server-ip/"
```

## 环境配置

### 开发环境配置

```ini
# config/mysql.ini
[database]
host = 127.0.0.1
user = root
password = "123456"
database = fcbmwos_dev
port = 3306

[system]
debug = true
log_level = debug
```

### 测试环境配置

```ini
# config/mysql.ini
[database]
host = test-db.example.com
user = test_user
password = "test_password"
database = fcbmwos_test
port = 3306

[system]
debug = false
log_level = info
```

### 生产环境配置

```ini
# config/mysql.ini
[database]
host = prod-db.example.com
user = fcbmwos_prod
password = "complex_prod_password"
database = fcbmwos_prod
port = 3306

[system]
debug = false
log_level = error
```

## 安全配置

### 方法一: 文件权限

```bash
# 设置目录权限
find /var/www/fcbmwos -type d -exec chmod 755 {} \;

# 设置文件权限
find /var/www/fcbmwos -type f -exec chmod 644 {} \;

# 保护配置文件
chmod 600 /var/www/fcbmwos/config/*.ini
chown www-data:www-data /var/www/fcbmwos/config/*.ini
```

### 方法二: 防火墙配置

```bash
# Ubuntu UFW
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS firewalld
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

### 方法三: SSL证书

```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-apache
sudo certbot --apache -d your-domain.com
```

## 监控和维护

### 方法一: 日志监控

```bash
# 创建日志监控脚本
cat > /usr/local/bin/fcbmwos-monitor.sh << 'EOF'
#!/bin/bash
LOG_FILE="/var/log/fcbmwos.log"
ERROR_COUNT=$(grep -c "ERROR" "$LOG_FILE" 2>/dev/null || echo 0)

if [ "$ERROR_COUNT" -gt 10 ]; then
    echo "检测到大量错误: $ERROR_COUNT" | mail -s "FCBMWOS Alert" admin@example.com
fi
EOF

chmod +x /usr/local/bin/fcbmwos-monitor.sh

# 添加到crontab
echo "*/5 * * * * /usr/local/bin/fcbmwos-monitor.sh" | crontab -
```

### 方法二: 健康检查

```bash
# 创建健康检查脚本
cat > /usr/local/bin/health-check.sh << 'EOF'
#!/bin/bash
HEALTH_URL="http://localhost/api/config-manager.php?key=database.initialized"
RESPONSE=$(curl -s "$HEALTH_URL")

if [[ "$RESPONSE" != *"success\":true"* ]]; then
    echo "系统健康检查失败" | mail -s "Health Check Failed" admin@example.com
    systemctl restart apache2
fi
EOF
```

### 方法三: 自动备份

```bash
# 创建备份脚本
cat > /usr/local/bin/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/fcbmwos"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 备份数据库
mysqldump -u root -p123456 fcbmwos > "$BACKUP_DIR/db_$DATE.sql"

# 备份文件
tar -czf "$BACKUP_DIR/files_$DATE.tar.gz" /var/www/fcbmwos

# 清理旧备份（保留7天）
find "$BACKUP_DIR" -name "*.sql" -mtime +7 -delete
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +7 -delete
EOF

# 添加到crontab（每天凌晨2点备份）
echo "0 2 * * * /usr/local/bin/backup.sh" | crontab -
```

## 故障排除

### 常见问题

1. **数据库连接失败**
   ```bash
   # 检查MySQL服务
   systemctl status mysql
   
   # 检查配置文件
   cat config/mysql.ini
   
   # 测试连接
   mysql -h 127.0.0.1 -u root -p fcbmwos
   ```

2. **权限问题**
   ```bash
   # 重新设置权限
   chown -R www-data:www-data /var/www/fcbmwos
   chmod -R 755 /var/www/fcbmwos
   ```

3. **PHP错误**
   ```bash
   # 查看PHP错误日志
   tail -f /var/log/apache2/error.log
   
   # 检查PHP配置
   php -m | grep mysql
   ```

### 性能优化

1. **启用OPcache**
   ```ini
   # /etc/php/8.1/apache2/php.ini
   opcache.enable=1
   opcache.memory_consumption=128
   opcache.max_accelerated_files=4000
   ```

2. **MySQL优化**
   ```ini
   # /etc/mysql/mysql.conf.d/mysqld.cnf
   innodb_buffer_pool_size = 1G
   query_cache_size = 64M
   max_connections = 200
   ```

3. **Apache优化**
   ```apache
   # /etc/apache2/apache2.conf
   KeepAlive On
   MaxKeepAliveRequests 100
   KeepAliveTimeout 5
   ```

---

**注意事项**:
1. 生产环境部署前请充分测试
2. 定期备份数据库和配置文件
3. 监控系统性能和错误日志
4. 及时更新系统和依赖包
5. 配置适当的安全措施