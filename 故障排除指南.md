# 故障排除指南

## 概述

本指南提供了飞控板维修工单系统常见问题的诊断和解决方法。

## 问题分类

### 1. 数据库连接问题

#### 问题一: 数据库连接失败

**症状**:
- 页面显示"数据库连接失败"
- API返回数据库连接错误
- 系统无法正常启动

**诊断方法一**: 检查数据库服务状态
```bash
# 检查MySQL服务状态
systemctl status mysql
# 或
service mysql status

# 如果服务未运行，启动服务
sudo systemctl start mysql
```

**诊断方法二**: 验证数据库配置
```bash
# 查看配置文件
cat config/mysql.ini

# 测试数据库连接
mysql -h 127.0.0.1 -u root -p fcbmwos
```

**诊断方法三**: 检查网络连接
```bash
# 测试端口连通性
telnet 127.0.0.1 3306

# 或使用nc命令
nc -zv 127.0.0.1 3306
```

**解决方法一**: 修复配置文件
```bash
# 编辑配置文件
vim config/mysql.ini

# 确保配置正确
[database]
host = 127.0.0.1
user = root
password = "123456"
database = fcbmwos
port = 3306
```

**解决方法二**: 重置数据库密码
```bash
# 停止MySQL服务
sudo systemctl stop mysql

# 安全模式启动
sudo mysqld_safe --skip-grant-tables &

# 连接并重置密码
mysql -u root
USE mysql;
UPDATE user SET authentication_string=PASSWORD('123456') WHERE User='root';
FLUSH PRIVILEGES;
EXIT;

# 重启MySQL
sudo systemctl restart mysql
```

**解决方法三**: 创建数据库和用户
```sql
-- 连接MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE IF NOT EXISTS fcbmwos;

-- 创建用户
CREATE USER 'fcbmwos'@'localhost' IDENTIFIED BY '123456';

-- 授权
GRANT ALL PRIVILEGES ON fcbmwos.* TO 'fcbmwos'@'localhost';
FLUSH PRIVILEGES;
```

#### 问题二: 表不存在错误

**症状**:
- 错误信息: "Table 'fcbmwos.WorkOrder' doesn't exist"
- 数据库连接正常但查询失败

**解决方法一**: 重新初始化数据库
```bash
# 访问初始化页面
curl -X POST http://localhost:8000/api/database-init.php \
  -H "Content-Type: application/json" \
  -d '{"action":"initialize"}'
```

**解决方法二**: 手动创建表
```sql
-- 连接数据库
mysql -u root -p fcbmwos

-- 创建工单表
CREATE TABLE IF NOT EXISTS FCBMWO (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user VARCHAR(100) NOT NULL,
    work_order_no VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建维修记录表
CREATE TABLE IF NOT EXISTS DRARWO (
    id INT AUTO_INCREMENT PRIMARY KEY,
    work_order_id INT,
    repair_description TEXT,
    parts_used TEXT,
    repair_time DECIMAL(5,2),
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (work_order_id) REFERENCES FCBMWO(id)
);
```

### 2. PHP相关问题

#### 问题一: PHP扩展缺失

**症状**:
- 错误信息: "Call to undefined function mysqli_connect()"
- 数据库功能无法使用

**诊断方法一**: 检查PHP扩展
```bash
# 检查已安装的PHP扩展
php -m | grep mysql

# 检查PHP版本
php -v
```

**解决方法一**: 安装MySQL扩展
```bash
# Ubuntu/Debian
sudo apt install php-mysql php-mysqli

# CentOS/RHEL
sudo yum install php-mysql

# 重启Web服务器
sudo systemctl restart apache2
```

**解决方法二**: 启用扩展
```bash
# 编辑php.ini文件
sudo vim /etc/php/8.1/apache2/php.ini

# 取消注释以下行
extension=mysqli
extension=pdo_mysql

# 重启服务
sudo systemctl restart apache2
```

#### 问题二: 内存限制错误

**症状**:
- 错误信息: "Fatal error: Allowed memory size exhausted"
- 页面加载缓慢或失败

**解决方法一**: 增加内存限制
```bash
# 编辑php.ini
sudo vim /etc/php/8.1/apache2/php.ini

# 修改内存限制
memory_limit = 256M

# 重启服务
sudo systemctl restart apache2
```

**解决方法二**: 优化代码
```php
<?php
// 在脚本开始时设置内存限制
ini_set('memory_limit', '256M');

// 及时释放大变量
unset($large_array);

// 使用生成器处理大数据集
function getWorkOrders() {
    $result = mysqli_query($connection, $sql);
    while ($row = mysqli_fetch_assoc($result)) {
        yield $row;
    }
}
?>
```

#### 问题三: 文件权限错误

**症状**:
- 错误信息: "Permission denied"
- 无法写入配置文件
- 上传功能失败

**诊断方法一**: 检查文件权限
```bash
# 查看文件权限
ls -la config/
ls -la api/

# 查看所有者
stat config/mysql.ini
```

**解决方法一**: 修复权限
```bash
# 设置正确的所有者
sudo chown -R www-data:www-data /var/www/fcbmwos/

# 设置目录权限
find /var/www/fcbmwos -type d -exec chmod 755 {} \;

# 设置文件权限
find /var/www/fcbmwos -type f -exec chmod 644 {} \;

# 配置文件特殊权限
chmod 600 /var/www/fcbmwos/config/*.ini
```

**解决方法二**: 检查SELinux（CentOS/RHEL）
```bash
# 检查SELinux状态
getenforce

# 如果是Enforcing，设置正确的上下文
sudo setsebool -P httpd_can_network_connect 1
sudo restorecon -R /var/www/fcbmwos/
```

### 3. Web服务器问题

#### 问题一: Apache无法启动

**症状**:
- Apache服务启动失败
- 端口被占用错误

**诊断方法一**: 检查错误日志
```bash
# 查看Apache错误日志
sudo tail -f /var/log/apache2/error.log

# 检查服务状态
systemctl status apache2
```

**诊断方法二**: 检查端口占用
```bash
# 检查80端口占用
sudo netstat -tlnp | grep :80
# 或
sudo ss -tlnp | grep :80
```

**解决方法一**: 修复配置错误
```bash
# 测试Apache配置
sudo apache2ctl configtest

# 如果有语法错误，修复配置文件
sudo vim /etc/apache2/sites-available/fcbmwos.conf
```

**解决方法二**: 解决端口冲突
```bash
# 停止占用端口的进程
sudo kill -9 <PID>

# 或修改Apache端口
sudo vim /etc/apache2/ports.conf
# 修改为其他端口，如8080
Listen 8080
```

#### 问题二: 404错误

**症状**:
- 页面显示"404 Not Found"
- API接口无法访问

**解决方法一**: 检查文件路径
```bash
# 确认文件存在
ls -la /var/www/fcbmwos/login.html
ls -la /var/www/fcbmwos/api/

# 检查虚拟主机配置
sudo vim /etc/apache2/sites-available/fcbmwos.conf
```

**解决方法二**: 启用mod_rewrite
```bash
# 启用mod_rewrite模块
sudo a2enmod rewrite

# 重启Apache
sudo systemctl restart apache2
```

**解决方法三**: 配置.htaccess
```apache
# 在项目根目录创建.htaccess
RewriteEngine On

# API路由重写
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ api/index.php [QSA,L]
```

### 4. 配置文件问题

#### 问题一: 配置文件格式错误

**症状**:
- 系统无法读取配置
- 解析错误信息

**诊断方法一**: 验证INI格式
```bash
# 使用PHP验证配置文件
php -r "
\$config = parse_ini_file('config/mysql.ini', true);
if (\$config === false) {
    echo '配置文件格式错误\n';
} else {
    print_r(\$config);
}
"
```

**解决方法一**: 修复格式错误
```ini
# 正确的INI格式
[database]
host = 127.0.0.1
user = root
password = "123456"  ; 密码包含特殊字符时使用引号
database = fcbmwos
port = 3306

# 错误示例（避免）
[database
host = 127.0.0.1  ; 缺少闭合括号
user = root
password = 123456  ; 密码包含特殊字符但未使用引号
```

#### 问题二: 配置文件不存在

**症状**:
- 错误信息: "配置文件不存在"
- 系统初始化失败

**解决方法一**: 创建默认配置
```bash
# 创建配置目录
mkdir -p config

# 创建默认配置文件
cat > config/mysql.ini << 'EOF'
[database]
host = 127.0.0.1
user = root
password = "123456"
database = fcbmwos
port = 3306
charset = utf8

[connection]
timeout = 30
persistent = false
max_connections = 100
EOF

# 创建应用配置
cat > config/app-config.ini << 'EOF'
[database]
initialized = false

[system]
version = 1.0.0
debug = false
log_level = info
EOF
```

### 5. API接口问题

#### 问题一: JSON解析错误

**症状**:
- 错误信息: "JSON解析失败"
- API返回格式错误

**诊断方法一**: 检查API输出
```bash
# 测试API接口
curl -v http://localhost:8000/api/config-manager.php?key=database.initialized

# 检查响应头
curl -I http://localhost:8000/api/config-manager.php
```

**解决方法一**: 修复输出问题
```php
<?php
// 确保没有额外输出
ob_start();

// 设置正确的Content-Type
header('Content-Type: application/json; charset=utf-8');

// 清理输出缓冲区
ob_clean();

// 输出JSON
echo json_encode($response);
exit;
?>
```

**解决方法二**: 检查PHP错误
```bash
# 启用错误显示（仅开发环境）
php -d display_errors=1 -d error_reporting=E_ALL -S localhost:8000

# 查看错误日志
tail -f /var/log/php_errors.log
```

#### 问题二: CORS跨域问题

**症状**:
- 浏览器控制台显示CORS错误
- 前端无法访问API

**解决方法一**: 添加CORS头
```php
<?php
// 在API文件开头添加
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization');

// 处理预检请求
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}
?>
```

**解决方法二**: Apache配置
```apache
# 在虚拟主机配置中添加
<Directory /var/www/fcbmwos>
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
</Directory>
```

### 6. 性能问题

#### 问题一: 页面加载缓慢

**症状**:
- 页面响应时间过长
- 数据库查询缓慢

**诊断方法一**: 分析慢查询
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query_log%';
```

**解决方法一**: 优化数据库查询
```sql
-- 添加索引
CREATE INDEX idx_work_order_no ON FCBMWO(work_order_no);
CREATE INDEX idx_status ON FCBMWO(status);
CREATE INDEX idx_created_at ON FCBMWO(created_at);

-- 优化查询语句
-- 避免SELECT *，只选择需要的字段
SELECT id, work_order_no, status FROM FCBMWO WHERE status = 'pending';
```

**解决方法二**: 启用缓存
```php
<?php
// 简单的文件缓存实现
function getCache($key, $ttl = 3600) {
    $file = "cache/{$key}.cache";
    if (file_exists($file) && (time() - filemtime($file)) < $ttl) {
        return unserialize(file_get_contents($file));
    }
    return false;
}

function setCache($key, $data) {
    $file = "cache/{$key}.cache";
    file_put_contents($file, serialize($data));
}
?>
```

#### 问题二: 内存使用过高

**症状**:
- 服务器内存不足
- PHP进程被杀死

**解决方法一**: 优化PHP配置
```ini
# php.ini优化
memory_limit = 128M
max_execution_time = 30
max_input_vars = 1000

# 启用OPcache
opcache.enable=1
opcache.memory_consumption=128
opcache.max_accelerated_files=4000
```

**解决方法二**: 代码优化
```php
<?php
// 使用生成器处理大数据集
function getWorkOrdersGenerator($limit = 1000) {
    $offset = 0;
    do {
        $sql = "SELECT * FROM FCBMWO LIMIT $limit OFFSET $offset";
        $result = mysqli_query($connection, $sql);
        $count = 0;
        
        while ($row = mysqli_fetch_assoc($result)) {
            yield $row;
            $count++;
        }
        
        $offset += $limit;
    } while ($count === $limit);
}

// 及时释放资源
mysqli_free_result($result);
mysqli_close($connection);
?>
```

### 7. 安全问题

#### 问题一: SQL注入风险

**症状**:
- 安全扫描发现SQL注入漏洞
- 异常的数据库查询

**解决方法一**: 使用预处理语句
```php
<?php
// 错误的做法（存在SQL注入风险）
$sql = "SELECT * FROM FCBMWO WHERE id = " . $_GET['id'];

// 正确的做法
$stmt = $pdo->prepare("SELECT * FROM FCBMWO WHERE id = ?");
$stmt->execute([$_GET['id']]);
$result = $stmt->fetch();
?>
```

**解决方法二**: 输入验证
```php
<?php
function validateInput($input, $type) {
    switch ($type) {
        case 'int':
            return filter_var($input, FILTER_VALIDATE_INT);
        case 'email':
            return filter_var($input, FILTER_VALIDATE_EMAIL);
        case 'string':
            return htmlspecialchars(trim($input), ENT_QUOTES, 'UTF-8');
        default:
            return false;
    }
}

$id = validateInput($_GET['id'], 'int');
if ($id === false) {
    http_response_code(400);
    echo json_encode(['error' => '无效的ID参数']);
    exit;
}
?>
```

#### 问题二: 文件上传安全

**症状**:
- 恶意文件上传
- 服务器被攻击

**解决方法一**: 文件类型验证
```php
<?php
function validateFileUpload($file) {
    $allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
    $maxSize = 5 * 1024 * 1024; // 5MB
    
    if (!in_array($file['type'], $allowedTypes)) {
        return ['error' => '不支持的文件类型'];
    }
    
    if ($file['size'] > $maxSize) {
        return ['error' => '文件大小超过限制'];
    }
    
    // 检查文件内容
    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $mimeType = finfo_file($finfo, $file['tmp_name']);
    finfo_close($finfo);
    
    if (!in_array($mimeType, $allowedTypes)) {
        return ['error' => '文件内容与扩展名不匹配'];
    }
    
    return ['success' => true];
}
?>
```

## 监控和预防

### 方法一: 日志监控

```bash
# 创建日志监控脚本
cat > /usr/local/bin/log-monitor.sh << 'EOF'
#!/bin/bash

LOG_FILES=(
    "/var/log/apache2/error.log"
    "/var/log/mysql/error.log"
    "/var/log/php_errors.log"
)

for log_file in "${LOG_FILES[@]}"; do
    if [ -f "$log_file" ]; then
        # 检查最近5分钟的错误
        errors=$(tail -n 100 "$log_file" | grep "$(date -d '5 minutes ago' '+%Y-%m-%d %H:%M')" | wc -l)
        if [ "$errors" -gt 10 ]; then
            echo "警告: $log_file 发现大量错误 ($errors)" | mail -s "系统警告" admin@example.com
        fi
    fi
done
EOF

chmod +x /usr/local/bin/log-monitor.sh

# 添加到crontab
echo "*/5 * * * * /usr/local/bin/log-monitor.sh" | crontab -
```

### 方法二: 健康检查

```bash
# 创建健康检查脚本
cat > /usr/local/bin/health-check.sh << 'EOF'
#!/bin/bash

# 检查Web服务
if ! curl -f -s http://localhost/login.html > /dev/null; then
    echo "Web服务异常" | mail -s "健康检查失败" admin@example.com
    systemctl restart apache2
fi

# 检查数据库
if ! mysql -u root -p123456 -e "SELECT 1" > /dev/null 2>&1; then
    echo "数据库服务异常" | mail -s "健康检查失败" admin@example.com
    systemctl restart mysql
fi

# 检查磁盘空间
disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$disk_usage" -gt 80 ]; then
    echo "磁盘空间不足: ${disk_usage}%" | mail -s "磁盘空间警告" admin@example.com
fi
EOF
```

### 方法三: 自动修复

```bash
# 创建自动修复脚本
cat > /usr/local/bin/auto-fix.sh << 'EOF'
#!/bin/bash

# 修复文件权限
fix_permissions() {
    chown -R www-data:www-data /var/www/fcbmwos/
    find /var/www/fcbmwos -type d -exec chmod 755 {} \;
    find /var/www/fcbmwos -type f -exec chmod 644 {} \;
    chmod 600 /var/www/fcbmwos/config/*.ini
}

# 清理临时文件
cleanup_temp() {
    find /tmp -name "php*" -mtime +1 -delete
    find /var/www/fcbmwos/cache -name "*.cache" -mtime +1 -delete
}

# 重启服务
restart_services() {
    systemctl restart apache2
    systemctl restart mysql
}

# 执行修复
fix_permissions
cleanup_temp

# 如果服务异常，重启服务
if ! systemctl is-active --quiet apache2; then
    restart_services
fi
EOF
```

## 联系支持

如果以上方法无法解决问题，请：

1. **收集信息**:
   - 错误日志
   - 系统配置
   - 重现步骤

2. **联系方式**:
   - 邮箱: support@example.com
   - 电话: 400-xxx-xxxx
   - 在线支持: https://support.example.com

3. **提供信息**:
   - 系统版本
   - 错误截图
   - 详细描述

---

**注意**: 在生产环境中进行任何修改前，请先在测试环境中验证解决方案。